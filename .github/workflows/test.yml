name: Build Kewl Kernel for sweet

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v2
      with:
        repository: 'sajadasadollahi83/kernel_xiaomi_sweet_kewl'
        ref: 'lineage-21-ksu'

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Install Clang 18
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 18

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          bc \
          ccache

    - name: Set Environment Variables
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "KBUILD_BUILD_USER=ventur" >> $GITHUB_ENV
        echo "PATH=/usr/lib/llvm-18/bin:$PATH" >> $GITHUB_ENV
        echo "CC=clang-18" >> $GITHUB_ENV
        echo "LD=ld.lld-18" >> $GITHUB_ENV

    - name: Build Kernel
      run: |
        make O=out ARCH=arm64 sweet_user_defconfig
        make -j$(nproc) \
          O=out \
          ARCH=arm64 \
          LLVM_IAS=1 \
          CC="ccache clang-18" \
          LD=ld.lld-18 \
          CROSS_COMPILE=aarch64-linux-gnu- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi-

    - name: Upload Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: kernel-build
        path: |
          out/arch/arm64/boot/Image.gz-dtb
          out
